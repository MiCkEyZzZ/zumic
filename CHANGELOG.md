# Changelog

[Unreleased]

### Добавлено

- **Pub/Sub: Асинхронный API для подписок**
  - В типы `Subscription` и `PatternSubscription` добавлены методы:
    - `async fn recv()` — асинхронное получение следующего сообщения.
    - `fn try_recv()` — немедленное попытка получить сообщение без блокировки (`Subscription`).
  - Использование внутренних приемников через `receiver()` помечено как устаревшее (`deprecated`) с рекомендацией пользоваться новым API.
  - Обеспечена полная совместимость с Tokio broadcast каналами.
  - Добавлены подробные комментарии и документация для новых методов.
  - Проведено плотное покрытие тестами (unit и integration) функционала асинхронного получения сообщений.
  - Улучшена эргономика и безопасность работы с подписками во внутренней pub/sub системе.

- **ZDB (Zumic Dump File) — Продвинутая система версионирования формата дампов**:
  - Введена поддержка legacy дампов без явной версии.
  - Реализована многоуровневая проверка совместимости версий (`can_read`, `can_write`).
  - Добавлена детальная диагностика и предупреждения при работе с устаревшими и несовместимыми версиями.
  - Введены рекомендации по миграции устаревших версий к новым форматам.
  - Реализован API для определения версии дампа и проверки совместимости с текущим читателем.
  - Добавлены обширные unit-тесты, покрывающие все аспекты версии и миграции.

- **GitHub Action**:
  - **CI/CD и шаблоны GitHub**:
    - Добавлены шаблоны Issues: `enhancement.yml`, `feature.yml`, `question.yml`, `config.yml`.
    - Добавлен workflow `release.yml` для автоматизации публикаций релизов.
  - **book**
    - Добавлены базовые главы и их описание.

- **Env**
  - **Environment configuration** (`.env`)
    ```dotenv
     ZUMIC_LISTEN_ADDRESS=**
     ZUMIC_MAX_CONNECTIONS=**
     ZUMIC_AOF_PATH=**
     ZUMIC_DSNAPSHOT_PATH=**
     ZUMIC_SNAPSHOT_FREQ=**
     ZUMIC_MAX_MEMORY=**
     ZUMIC_LOG_LEVEL=**
     ZUMIC_PASSWORD=**
     ZUMIC_TLS_CERT=**
     ZUMIC_TLS_KEY=**
     ZUMIC_THREAD_POOL=*
    ```

- **Модули**
  - Добавлены каркас и менеджер плагинов:
    - Файл `modules/api.rs` с трэйтом `Module`.
    - Файл `modules/loader.rs` с динамической загрузкой `.so/.dll`.
    - Файл `modules/wasm.rs` с обёрткой для WASM.
    - Файл `modules/plugin_manager.rs` (раньше `mod.rs`) с `Plugin` и `Manager`.

- **Lua Integration**:
  - Внедрена базовая интеграция Lua-скриптов с использованием библиотеки `mlua`.
  - Добавлен безопасный движок выполнения Lua-скриптов (`LuaEngine`) с конфигурируемыми ограничениями по времени, памяти и количеству инструкций.
  - Реализован экспорт типа `Sds` в Lua с методами: `.len()`, `.to_vec()`, `.as_str()`, `.substr()`, `.concat()`, `.upper()`, `.lower()`.
  - Обеспечена песочница для скриптов: отключён доступ к OS/файлам/сети, предотвращены бесконечные циклы и превышение памяти.
  - Добавлена функция выполнения Lua-скриптов с передачей аргументов и возвратом результата.
  - Написан набор автоматизированных тестов, покрывающих работу движка, методы `Sds` и обработку ошибок.

### Изменено

  - Внёс улучшения в файл `SECURITY.md`;
  - Вынес файл `pull_request_template.md` в корень .github;
  - Улучшена обработка ошибок с использованием новых ошибок `VersionError` и лучшее логирование для диагностики версий.
  - Устранены Clippy предупреждения `uninlined_format_args` во всём pub/sub коде: все форматные макросы `format!`, `println!` и `panic!` переведены на современный рекомендуемый синтаксис с захватом переменных (`format!("msg{i}")` вместо `format!("msg{}", i)`), что позволило успешно пройти сборку и CI/CD.

- **Pub/Sub: Улучшена обработка ошибок**
  - Введены централизованные типы ошибок `RecvError` и `TryRecvError` в модуле `src/error/pubsub.rs`.
  - Заменены ранее использовавшиеся generic ошибки `tokio::sync::broadcast::error::RecvError` на подробные и семантически значимые варианты ошибок.
  - Добавлены варианты ошибок для таких случаев, как закрытый канал, таймаут, сериализационные ошибки, отставание приёмника, превышение лимита подписчиков, некорректные паттерны и несуществующие каналы.
  - Реализованы преобразования (`From`) из ошибок `broadcast` и `globset` в новые типы ошибок.
  - Обновлена сигнатура методов в `Subscription`, `PatternSubscription` и `Broker` для использования новых ошибок.
  - Обеспечена лучшая диагностика и типобезопасность при работе с Pub/Sub API.

## [v0.1.0] - 2025-08-06

### Добавлено

- **Основные команды**:
  - Реализованы базовые команды для строк: `SET`, `GET`, `DEL`, `EXISTS`, и т.д.
  - Реализованы базовые команды для чисел: `INCR`, `DECR`, `INCRBY`, `DECRBY`.
  - Реализованы базовые команды для чисел: `INCRBYFLOAT`, `DECRBYFLOAT`, `SETFLOAT`.
  - Добавлены тесты для методов: `INCRBYFLOAT`, `DECRBYFLOAT`, `SETFLOAT`.
  - Реализованы базовые команды для hash: `HSET`, `HGET`, `HDEL`, `HGETALL`.
  - Добавлены тесты для методов: `HSET`, `HGET`, `HDEL`, `HGETALL`.
  - Реализованы базовые команды для множеств: `SADD`, `SREM`, `SCARD`, `SMEMBERS`, `SISMEMBER`.
  - Добавлены тесты для методов: `SADD`, `SREM`, `SCARD`, `SMEMBERS`, `SISMEMBER`.
  - Реализованы базовые команды для отсортированных множеств: `ZADD`, `ZSCORE`, `ZCARD`, `ZREM`, `ZRANGE`, `ZREVRANGE`.
  - Добавлены тесты для методов: `ZADD`, `ZSCORE`, `ZCARD`, `ZREM`, `ZRANGE`, `ZREVRANGE`.
  - Реализованы базовые команды для списков: `LPUSH`, `RPUSH`, `LPOP`, `RPOP`, `LLEN`, `LRANGE`.
  - Добавлены тесты для методов: `LPUSH`, `RPUSH`, `LPOP`, `RPOP`, `LLEN`, `LRANGE`.
  - Добавлены три новых метода для типа `ArcBytes` следующие: `expect_utf8`, `make_mut`, `try_unwrap`.
  - Добавлены три новых метода для типа `SmartHash` следующие: `new`, `hset`, `hget`, `hdel`.
  - Добавлены тесты для типа `SmartHash` его методов: `new`, `hset`, `hget`, `hdel`.
  - Добавил дополнительные методы для типа `SkipList`: `contains`, `is_empty`, `clear`, `front`, `back`.
  - Добавил тесты для всех методов `SkipList`.
  - Добавил дополнительные методы для типа `SmartHash`: `keys`, `values`, `entries`, `do_downgrade`.

- **Бенчмарки**:

  - Добавлены бенчмарки для следующих команд: `basic`, `float`, `int`, `string`, `hash`, `set`, `list`, `zset`.

- **GEO-команды**:
  - Реализованы команды работы с геоданными: `GEOADD`, `GEOPOS`, `GEODIST`, `GEORADIUS`, `GEORADIUSBYMEMBER`.
  - Поддержка хранения и извлечения координат с высокой точностью.
  - Добавлены тесты на корректность гео-вычислений и сериализации ответов.

- **Поддержка GEO в ZDB и ZSP**:
  - Обновлены `zdb` и `zsp` модули для поддержки сериализации массивов гео-результатов.
  - Обновлён тип `Value` для поддержки GEO-ответов.


- **Кастомные типы**:

  - Реализованы кастомные типы, такие как `ArcBytes` и `QuickList`.
  - Реализован кастомный типы, такие как `Zip` и `Map` в перечислении `SmartHash`.

- **ZSP (Zumic Serialization Protocol)**:

  - Реализованы декодер, encoder, типы для обработки различных типов данных (`Int`, `Str`, `List`, `Set`, `Hash`, `ZSet`).
  - Поддержка частичного чтения для строк и массивов.
  - Добавлен протокол сериализации ZSP с поддержкой кастомных типов и базовых операций.

- **ACL**:

  - Реализовано управление пользователями, разрешениями и обработка каналов.
  - Поддержка загрузки конфигурации пользователей из `zumic.conf` с шаблонами пользователей.

- **Аутентификация**:

  - Реализован модуль `auth` с поддержкой аутентификации пользователей и ACL.

- **Хеширование паролей**:

  - Реализовано хеширование паролей с использованием библиотеки `argon2` в модуле `password.rs`.

- **Модуль команд**:

  - Реализована базовая структура команд с командами: `SetCommand`, `GetCommand`, `DelCommand`, `MsetCommand`.

- **Модуль сети**:

  - Начата реализация базового TCP-сервера для сетевого взаимодействия.

- **Типы и утилиты**:

  - Определен enum `Value` с типами данных, такими как `Int`, `Str`, `List`, `Set` и другие.
  - Введены вспомогательные структуры, такие как `ArcBytes`, для эффективной работы с байтами.
  - Введены вспомогательные структуры, такие как `SkipList`, для эффективной работы с отсортированными коллекциями.

- **Инициализация проекта**:
  - Изначальная настройка структуры проекта и базовых утилит.

### Изменено

- Существенные обновления реализации ZSP для улучшения совместимости с различными типами данных, такими как строки, множества, хеши и другие.
- Изменена логика ф-ии. Результат улучшена производительность для команды `AppendCommand`.
- Добавил документацию: `database`, `command`.
- Изменил логику ф-ии. `hset`, `hdel` в перечислении `SmartHash`.
- Изменил логику ф-ии в zsp/frame/zap_types: `convert_smart_hash`
- Изменил логику ф-ии в zsp/protocol/seriazizer: `value_to_frame`
- Изменил логику ф-ии в command/zset для всех: `execute` ф-ий.
- Изменил логику работы database/skip_list добавил ф-ю: `find_update` для более безопасной работы с сырыми указателями в unsave режиме.
- Изменил логику работы database/skip_list добавил поле `backward` в структуру Node.
- Изменил названия методов в `SmartHash` на: `insert`, `get`, `remove`, `get_all`.
- Расширен интерфейс `Store` для поддержки операций с геоданными.
- Обновлены реализации `MemoryStore`, `PersistentStore`, `ClusterStore` для полной поддержки GEO-команд.
- Переработан `StorageEngine` с маршрутизацией GEO-команд в соответствующий backend.
- Изменена логика сериализации в `zsp` для поддержки вложенных структур гео-ответов (списки координат, расстояний и т.п.).


### Исправлено

- Исправлены проблемы с совместимостью различных типов данных ZSP при сериализации и десериализации.
- Исправил добавив реализацию `Drop` для `SkipList`, которая позволит автоматически освобождать памяти при уничтожении структуры.
