# --------------------------------------------------------------------
# Зумик — основной конфигурационный файл (значения по умолчанию)
# Этот файл коммитится в репозиторий и содержит значения по умолчанию.
# Переопределяйте в config/<profile>.toml или через переменные
# окружения ZUMIC_*
# --------------------------------------------------------------------

# ========================================
# ОСНОВНЫЕ НАСТРОЙКИ СЕРВЕРА
# ========================================

# Сеть
listen_address = "127.0.0.1:6174" # Адрес и порт для подключений
max_connections = 10000           # Максимальное число одновременных соединений
max_connections_per_ip = 100      # Максимум соединений с одного IP

# Таймауты (в секундах)
connection_timeout = 300 # Время простоя до разрыва соединения
read_timeout = 30        # Время ожидания команды от клиента
write_timeout = 10       # Время ожидания записи ответа

# Буферы
read_buffer_size = 8192 # Размер буфера чтения (байт)
shutdown_timeout = 30   # Время ожидания при graceful shutdown

# Пул потоков
thread_pool_size = 8 # Количество потоков для тяжёлых задач
worker_threads = 4   # Количество worker-потоков (опционально)

# ========================================
# НАСТРОЙКИ ХРАНИЛИЩА
# ========================================

# Тип хранилища: "memory" | "persistent" | "cluster"
storage_type = "memory"

# Память (для всех типов хранилища)
max_memory = "2GB"            # Лимит памяти
memory_policy = "allkeys-lru" # Политика вытеснения (опционально)

# Персистентность
aof_path = "./data/dump.aof" # Путь к AOF файлу
snapshot_freq = 300          # Частота снапшотов (секунды)
data_dir = "./data"          # Папка с данными
checkpoint_interval = 300    # Интервал чекпоинтов (секунды)
wal_enabled = true           # Включить WAL журналирование
compression = "lz4"          # Сжатие: "none" | "lz4" | "gzip"

# ========================================
# НАСТРОЙКИ ПЕРСИСТЕНТНОГО ХРАНИЛИЩА
# ========================================

[persistent_store]
sync_policy = "EverySecond"      # "Always" | "EverySecond" | "Manual"
enable_operation_logging = false # Логирование операций

# Шардирование
[persistent_store.sharding]
num_shards = 8                     # Количество шардов (рекомендуется: CPU cores * 2)
enable_metrics = true              # Включить метрики шардов
slow_operation_threshold_us = 1000 # Порог медленных операций (микросекунды)

# ========================================
# НАСТРОЙКИ КЛАСТЕРА
# ========================================

[cluster]
enabled = false                              # Включить кластерный режим
nodes = ["127.0.0.1:6175", "127.0.0.1:6176"] # Список узлов кластера
replica_factor = 1                           # Фактор репликации
consistency = "eventual"                     # Уровень консистентности: "strong" | "eventual"

# ========================================
# МОНИТОРИНГ И МЕТРИКИ
# ========================================

[monitoring]
metrics_enabled = true    # Включить сбор метрик
metrics_port = 9090       # Порт для метрик (Prometheus)
health_check_port = 8080  # Порт для health check
profiling_enabled = false # Включить профилирование

# ========================================
# БЕЗОПАСНОСТЬ И TLS
# ========================================

[tls]
enabled = false                               # Включить TLS
cert = "server.crt"                           # Путь к сертификату (опционально)
key = "server.key"                            # Путь к ключу (опционально)
allowed_ips = ["127.0.0.1", "192.168.1.0/24"] # Разрешённые IP адреса

# Простая аутентификация (опционально)
# requirepass = "supersecret"

# ========================================
# УПРАВЛЕНИЕ ПОЛЬЗОВАТЕЛЯМИ (ACL)
# ========================================

# Пользователь по умолчанию (без пароля, полные права)
[[users]]
name = "default"
nopass = true
pattern = "*"     # Доступ ко всем ключам
roles = ["admin"] # Роли пользователя

# Пример пользователя с ограниченными правами
[[users]]
name = "anton"
password_env = "ZUMIC_USER_ANTON_PASSWORD" # Пароль из переменной окружения
pattern = "data:*"                         # Доступ только к ключам с префиксом "data:"
permissions = ["get", "set"]               # Разрешённые команды

# ========================================
# НАСТРОЙКИ ПРОИЗВОДИТЕЛЬНОСТИ
# ========================================

# TCP настройки
tcp_nodelay = true   # Отключить алгоритм Nagle для меньшей задержки
tcp_keepalive = true # Включить TCP keepalive
so_reuseaddr = true  # Разрешить reuse адреса

# ========================================
# ЛОГИРОВАНИЕ (РАСШИРЕННОЕ)
# ========================================
[logging]
# Глобальный уровень: "trace" | "debug" | "info" | "warn" | "error"
level = "info"

# Формат вывода: "json" | "pretty" | "compact"
format = "pretty"

# Директория для логов
log_dir = "./logs"

# Политика ротации: "daily" | "hourly" | "never"
# Или: rotation = { size = { mb = 100 } }
rotation = "daily"

# Включить консольный вывод
console_enabled = true

# Включить запись в файл
file_enabled = true

# Максимальный размер файла (МБ) для size-based rotation
max_file_size_mb = 100

# Сколько дней хранить старые логи
rotation_days = 30

# Per-module уровня (опционально)
module_levels = []
# Примеры:
# module_levels = ["zumic::engine=debug", "zumic::network=trace"]

# ===== CUSTOM FIELDS (NEW) =====
[logging.custom_fields]
# Instance ID (auto from env ZUMIC_INSTANCE_ID)
# instance_id = "zumic-01"

# Version (auto from Cargo.toml)
# version = "1.0.0"

# Environment (auto from ZUMIC_ENV or RUST_ENV)
# environment = "production"

# hostname = "server-01"
# Hostname (auto detected)

# ===== TIMESTAMP CONFIG (NEW) =====
[logging.timestamp]
# Format: "rfc3339" | "unix" | "custom"
format = "rfc3339"

# Timezone: "utc" | "local"
timezone = "utc"

# ===== SPAN CONFIG (NEW) =====
[logging.span]
# Включить span name в логах
include_name = true

# Включить span fields
include_fields = true

# Включить full span list (all parent spans)
include_full_list = false

# Максимальная глубина span tree
max_depth = 5

# ========================================
# КОНСОЛЬ (OVERRIDE настроек)
# ========================================
[logging.console]
enabled = true
# format = "pretty" # Override формат для консоли
with_ansi = true          # Цвет ANSI
with_target = true        # Показывать module path
with_thread_ids = false   # Показывать thread IDs
with_line_numbers = false # Показывать номера строк

# ========================================
# ФАЙЛ (OVERRIDE настроек)
# ========================================
[logging.file]
enabled = true
filename = "zumic.log"
# format = "json" # Override формат для файла
# rotation = "daily" # Override политики ротации
# max_size_mb = 100
# retention_days = 30

# ===== ROTATION SETTINGS (NEW) =====

# Политика ротации (override глобальной)
# rotation = "daily"
# rotation = "hourly"
# rotation = { size = { mb = 100 } }

# Naming strategy: "simple" | "dated" | "sequential" | "full"
# simple:     zumic.log
# dated:      zumic-2025-10-06.log
# sequential: zumic-001.log, zumic-002.log
# full:       zumic-2025-10-06-001.log
naming = "dated"
# Compression старых файлов (gzip)
compress_old = false # true для production
# Retention policy
retention_days = 30 # Удалять файлы старше 30 дней
# Автоматический cleanup
auto_cleanup = true
# Интервал для background cleanup (секунды)
cleanup_interval_secs = 3600 # Каждый час
# Buffer size (байты)
buffer_size = 8192

# ========================================
# SLOW QUERY LOGGING (NEW - Issue #LOG-5)
# ========================================
[logging.slow_log]
# Включить slow query logging
enabled = true

# Отдельный файл для slow queries
filename = "slow-queries.log"

# Глобальный threshold (миллисекунды)
threshold_ms = 100

# Sample rate (0.0 - 1.0): 1.0 = log all, 0.1 = log 10%
sample_rate = 1.0

# Per-command thresholds (override глобальный)
[logging.slow_log.command_thresholds]
# GET обычно быстрый, порог 50ms
GET = 50
# SET немного медленнее, 100ms
SET = 100
# Scan операции могут быть медленными, 500ms
SCAN = 500
# KEYS очень медленный, 1000ms
KEYS = 1000

# Включить backtrace для debugging
enable_backtrace = false

# Максимальная длина args в логах
max_args_len = 256

# ===== ПРИМЕРЫ ДЛЯ РАЗНЫХ СЦЕНАРИЕВ =====

# High-volume production:
# [logging.file]
# rotation = { size = { mb = 500 } }
# compress_old = true
# retention_days = 7
# naming = "full"

# Development:
# [logging.file]
# rotation = "never"
# compress_old = false
# retention_days = 3

# Container environment (экономия места):
# [logging.file]
# rotation = { size = { mb = 10 } }
# compress_old = true
# retention_days = 1
# naming = "simple"

# ========================================
# ПРИМЕРЫ КОНФИГУРАЦИЙ ДЛЯ РАЗНЫХ РЕЖИМОВ
# ========================================

# Для переключения на персистентное хранилище раскомментируйте:
# storage_type = "persistent"

# Для кластерного режима:
# storage_type = "cluster"
# [cluster]
# enabled = true
# nodes = ["127.0.0.1:6174", "127.0.0.1:6175", "127.0.0.1:6176"]

# Для продакшена с TLS и аутентификацией:
# requirepass = "your_strong_password"
# [tls]
# enabled = true
# cert = "/path/to/server.crt"
# key = "/path/to/server.key"
